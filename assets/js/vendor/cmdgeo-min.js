(function(){var defaultSettings={"googleMapsKey":"","tourType":"LINEAIR","mapOptions":{"center":[52.35955620231157,4.908019635968003],"zoom":15,"mapTypeId":"ROADMAP"},"poiMarker":{"path":"CIRCLE","fillColor":"GhostWhite","strokeColor":"FireBrick"},"posMarker":{"path":"BACKWARD_CLOSED_ARROW","fillColor":"FireBrick","strokeColor":"Black"},"poiList":[]};var cmdgeo=function(obj){if(obj instanceof cmdgeo)return obj;if(!(this instanceof cmdgeo))return new cmdgeo(obj);this.cmdgeowrapped=obj};this.cmdgeo=
cmdgeo;cmdgeo.VERSION=0.2;cmdgeo.storage=cmdgeo.settings=cmdgeo.map=undefined;function existy(x){return x!==null}function truthy(x){return x!==false&&existy(x)}function storageSupported(){return typeof Storage!==undefined?cmdgeo.storage=sessionStorage:false}function settingsLoaded(){return isDefined(cmdgeo.settings)}function gpsInitialized(){return geo_position_js.init()}var isDefined=complement(_.isUndefined);function isDefinedInStorage(key){return isDefined(cmdgeo.storage[key])}function poiInStorage(poi){return isDefinedInStorage(poi.name)}
function poiStatusInactive(poi){return cmdgeo.storage.getItem(poi.name)==="false"}function hasEnterTarget(poi){return _.isString(poi.onEnter)&&poi.onEnter.length>0}function hasExitTarget(poi){return isDefined(poi.onExit)&&(_.isString(poi.onExit)&&poi.onExit.length>0)}var getPoiList=makeGetter("poiList",defaultSettings);var getTourType=makeGetter("tourType",defaultSettings);var getMapOptions=makeGetter("mapOptions",defaultSettings);var getPoiMarker=makeGetter("poiMarker",defaultSettings);var getPosMarker=
makeGetter("posMarker",defaultSettings);var getGoogleMapsKey=makeGetter("googleMapsKey",defaultSettings);var alwaysFail=validator("Failing deliberately",always(false));var settingsFormatting=checker();var storageRequirements=checker(validator("Storage (localStorage/ sessionStorage) is not supported on your system, this app can't live without it.",storageSupported));var trackRequirements=checker(validator("Unable to find settings, did you load them before calling the track() function?.",settingsLoaded),
validator("Unable to initialise GPS, this app can't live without it.",gpsInitialized));var canEnterPoi=checker(validator("Unable to find poi in storage, are you sure it's in your settings file?",poiInStorage),validator("The poi does not have an onEnter property.",hasEnterTarget),validator("The poi has to be inactive!",poiStatusInactive));var canExitPoi=checker(validator("Unable to find poi in storage, are you sure it's in your settings file?",poiInStorage),validator("The poi does not have an onExit property.",
hasExitTarget));cmdgeo.loadSettings=function loadSettings(url){cmdgeo.settings=readFileContents(url);errorDispatcher(settingsFormatting(cmdgeo.settings),fail);populateStorage(cmdgeo.settings)};function readFileContents(url){var request=chooseAppropriateRequestObject();request.open("GET",url,false);request.send(null);return JSON.parse(request.responseText)}function chooseAppropriateRequestObject(){return instantiateIfExists(window.XMLHttpRequest)||(instantiateIfExists(window.ActiveXObject)||fail("Your platform doesn't support HTTP request objects"))}
function populateStorage(settings){errorDispatcher(storageRequirements(),fail);_.each(getPoiList(settings),function(poi){return!(poi.name in cmdgeo.storage)?cmdgeo.storage.setItem(poi.name,false):false})}cmdgeo.track=function track(){errorDispatcher(trackRequirements(),fail);updatePosition()};function toRad(deg){return deg*(Math.PI/180)}function distance(c1,c2){return Math.acos(Math.sin(toRad(c1.latitude))*Math.sin(toRad(c2.latitude))+Math.cos(toRad(c1.latitude))*Math.cos(toRad(c2.latitude))*Math.cos(toRad(c2.longitude)-
toRad(c1.longitude)))*6376136}function updatePosition(){return geo_position_js.getCurrentPosition(gotPosition,function(c,m){fail(["geo.js",c,m].join(" "))},{enableHighAccuracy:true})}function gotPosition(pos){setTimeout(updatePosition,500);if(cmdgeo.map!==undefined)updateMap(pos);var poi=onPoi(pos.coords);if(poi){if(poiStatusInactive(poi))enterPoi(poi)}else{poi=findActivePoi();if(poi)exitPoi(poi)}}function onPoi(coord){return _.find(getPoiList(cmdgeo.settings),function(poi){return distance(coord,
poi.coordinate)<poi.radius},false)||false}function enterPoi(poi){return!errorDispatcher(canEnterPoi(poi),note)?activatePoi(poi):undefined}function exitPoi(poi){return!errorDispatcher(canExitPoi(poi),note)?deactivatePoi(poi):changePoiStatus(poi,false)}function findActivePoi(){return _.find(getPoiList(cmdgeo.settings),function(poi){return poi.name===_.find(_.keys(cmdgeo.storage),function(key){return cmdgeo.storage[key]==="true"})})}function activatePoi(poi){changePoiStatus(poi,true);window.location=
poi.onEnter}function deactivatePoi(poi){changePoiStatus(poi,false);window.location=poi.onExit}function changePoiStatus(poi,status){note(poi.name+(status?" activated":" deactivated"));cmdgeo.storage.setItem(poi.name,status)}cmdgeo.loadmap=function loadmap(){var script=document.createElement("script");script.src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&key="+getGoogleMapsKey(cmdgeo.settings)+"&callback=cmdgeo.drawmap";document.body.appendChild(script)};cmdgeo.drawmap=function drawmap(){formatSettings();
cmdgeo.map=new google.maps.Map(document.getElementById("map_canvas"),getMapOptions(cmdgeo.settings));drawroute()};function formatSettings(){cmdgeo.settings.mapOptions.center=new google.maps.LatLng(cmdgeo.settings.mapOptions.center[0],cmdgeo.settings.mapOptions.center[1]);cmdgeo.settings.mapOptions.mapTypeId=google.maps.MapTypeId[cmdgeo.settings.mapOptions.mapTypeId];cmdgeo.settings.posMarker.path=google.maps.SymbolPath[cmdgeo.settings.posMarker.path];cmdgeo.settings.poiMarker.path=google.maps.SymbolPath[cmdgeo.settings.poiMarker.path]}
function drawroute(){cmdgeo.map.route=_.map(getPoiList(cmdgeo.settings),function(poi){return new google.maps.LatLng(poi.coordinate.latitude,poi.coordinate.longitude)});cmdgeo.map.markers=_.map(getPoiList(cmdgeo.settings),function(poi,i){return new google.maps.Marker({position:cmdgeo.map.route[i],map:cmdgeo.map,icon:getPoiMarker(cmdgeo.settings),title:poi.name})});if(getTourType(cmdgeo.settings)==="LINEAIR")var route=new google.maps.Polyline({clickable:false,map:cmdgeo.map,path:cmdgeo.map.route,strokeColor:"Black",
strokeOpacity:0.6,strokeWeight:3});cmdgeo.map.pm=new google.maps.Marker({position:getMapOptions(cmdgeo.settings).center,map:cmdgeo.map,icon:getPosMarker(cmdgeo.settings)})}function updateMap(pos){cmdgeo.map.pm.setPosition(new google.maps.LatLng(pos.coords.latitude,pos.coords.longitude));cmdgeo.map.setCenter(cmdgeo.map.pm.position)}function errorDispatcher(errs,fun){return errs.length>0?!fun(errs):false}function fail(thing){throw new Error(thing);}function warn(thing){console.log(["WARNING:",thing].join(" "))}
function note(thing){console.log(["NOTE:",thing].join(" "))}function always(val){return function(){return val}}function complement(predicate){return function(){return!predicate.apply(null,_.toArray(arguments))}}function doWhen(condition,action1,action2){return truthy(condition)?action1():action2()}function instantiateIfExists(Target){return doWhen(existy(Target),function(){return new Target})}function fnull(fun){var defaults=_.rest(arguments);return function(){return fun.apply(null,_.map(arguments,
function(arg,i){return existy(arg)?arg:defaults[i]}))}}function defaults(def){return function(obj,key){var val=fnull(_.identity,def[key]);return obj&&val(obj[key])}}function makeGetter(key,def){return function(obj){return defaults(def)(obj,key)}}function checker(){var validators=_.toArray(arguments);return function(obj){return _.reduce(validators,function(errs,check){if(check(obj))return errs;else return _.chain(errs).push(check.message).value()},[])}}function validator(message,fun){var f=function(){return fun.apply(fun,
arguments)};f.message=message;return f}}).call(this);